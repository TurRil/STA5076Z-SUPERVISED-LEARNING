---
title: "Untitled"
author: "Corn√© Oosthuizen - OSTAND005"
date: "22 June 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup-1}
source("utils.R")

dataset.list <- dataset.stats

for (i in 1:nrow(dataset.list)) {
  df.name <- dataset.list[i, 1]
  df.data <- readDF(paste('data/', df.name, '.csv', sep=""))
  assign(df.name, df.data) 
}

rm(df.name)
rm(df.data)
rm(i)

```

```{r pca}
createDataSet.pca <- function(source) {
  
  source.df <- eval(parse(text = source$name))

  startTime <- proc.time()
  
    pca.out <- prcomp(source.df[,-1])
    
    pca.cutoff <- min(which(summary(pca.out)$importance[3,] > 0.99))
    
    feature.vector <- pca.out$rotation[, 1:pca.cutoff]
    compact.data <- t( t(feature.vector) %*% t(source.df[,-1]) ) # Take the itersect of features and data frame and flip it back
  
    newDF <- data.frame(matrix(ncol = pca.cutoff + 1, nrow = nrow(source.df)))
    newNames <- c('label', paste0('pca_', 1:pca.cutoff))
    
    resultDF <- cbind(source.df$label, compact.data)
    names(resultDF) <- newNames
  
  endTime <- proc.time()
  runTime <- endTime - startTime
  
  filename <- paste(source$name, "_pca", sep="")
  
  # write out the new dataset
  write.csv(new.df, file = paste('data/', filename ,'.csv', sep =''))
  saveRDS(new.df, file = paste('data/', filename ,'.rds', sep =''))
  
  saveRDS(new.df, file = paste('data/', filename ,'.rds', sep =''))
  
  # add it's details for comparison
  return (returnStat(name = filename, type = source$type, 
                     pixels = 0, # cant' map to pixels anymore 
                     sk = source$sk,
                     sym = source$sym,
                     pca = 1, # the one we are changing
                     obs = dim(resultDF)[1], 
                     var = dim(resultDF)[2], 
                     time_s = runTime[3], 
                     size_b = object.size(resultDF)))
}
```

  
  pca.var <- (pca.out$sdev)^2
  pca.var.max <- round(max(pca.var),1)
  
  pca.comp <- 1:length(pca.var)
  pca.comp <- as.integer(pca.comp)
  
  plot(pca.comp, pca.var, 
       main = paste("Scree Plot for ", filename ," [", pca.cutoff ,"]", sep =""),
       xlab = "Number of Components", 
       ylab = "Variance",
       type = "l",
       col  = "blue",
       ylim = c(0, pca.var.max),
       axes = FALSE)
  
  axis(1, at=1:length(pca.comp))
  axis(2, at=0:pca.var.max)
  abline(v = pca.cutoff, col="red", lty=3)
  
  plot(summary(pca.out)$importance[3,], type="l", 
       ylab="%variance explained", 
       xlab="nth component (decreasing order)", 
       main = paste("Variance Description on ", filename ," [", pca.cutoff ,"]", sep =""))
  abline(h = 0.99, col = "red")
  abline(v = pca.cutoff, col="red", lty=3)
  
  # add it's details for comparison
  #return (as.list(c(filename, source.type, 0, 1, 0, 0, dim(new.df)[1], dim(new.df)[2], runTime[3], object.size(new.df))))
#}

#pca.28 <- princomp(train.28, scores=T)
#pca.14 <- princomp(train.14, scores=T)
#pca.7 <- princomp(train.7, scores=T)


```{r}
dataset.empty <- getEmptyStat()

for(i in 1:nrow(dataset.list)) {
  dataset.empty <- rbind(dataset.empty, createDataSet.pca(dataset.list[i,]))
}

dataset.empty <- as.data.frame(dataset.empty)
a <- rbind(dataset.stats, dataset.empty)
print(dataset.empty)
```